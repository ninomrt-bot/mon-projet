(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[874],{38882:(e,t,a)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/alertes",function(){return a(80181)}])},80181:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>u});var s=a(37876),l=a(14232),n=a(10553),r=a(89099),i=a(75656),o=a(14312),d=a(9665);let c=e=>fetch(e).then(e=>e.json());function u(){let{data:e,status:t}=(0,n.useSession)(),a=(0,r.useRouter)(),{data:u,error:p,mutate:m}=(0,i.Ay)("/api/stock",c),x=(0,l.useMemo)(()=>Array.isArray(u)?u.map(e=>{var t;return{...e,Ref:String(null!=(t=e.Ref)?t:"").trim()}}):[],[u]),[h,f]=(0,l.useState)(""),[b,g]=(0,l.useState)(!1),[y,j]=(0,l.useState)(""),[N,v]=(0,l.useState)([]),[T,w]=(0,l.useState)(""),[C,F]=(0,l.useState)(1),[S,R]=(0,l.useState)(0);(0,l.useEffect)(()=>{"unauthenticated"===t&&a.push("/login")},[t,a]);let k=(0,l.useMemo)(()=>x.map(e=>{var t,a,s;let l=Number(null!=(t=e["Qte stock"])?t:0)+Number(null!=(a=e["En Commande"])?a:0),n=Number(null!=(s=e["Qte mini"])?s:0)-l;return n>0?{...e,toOrder:n}:null}).filter(Boolean),[x]),q=(0,l.useMemo)(()=>Array.from(new Set(k.map(e=>e.Fournisseurs).filter(Boolean))).sort(),[k]),A=h?k.filter(e=>e.Fournisseurs===h):k;(0,l.useEffect)(()=>{b&&(v(k.filter(e=>!y||e.Fournisseurs===y).map(e=>{var t;return{Ref:e.Ref,description:e["D\xe9signation"],qty:e.toOrder,pu:Number(null!=(t=e["PU HT"])?t:0)}})),w(""),F(1),R(0))},[b,y,k]);let E=(0,l.useMemo)(()=>{let e=N.reduce((e,t)=>e+t.qty*t.pu,0),t=.2*e;return{ht:e,tva:t,ttc:e+t}},[N]);async function _(){let e=new o.uE({unit:"pt",format:"a4"});e.addImage("/logo_stirweld.png","PNG",450,20,100,40),e.setFontSize(22).setTextColor("#00a6b2").text("Bon de commande",40,60),e.setDrawColor("#00a6b2").line(40,70,555,70),e.setFontSize(12).setTextColor("#000"),["Stirweld SAS","4K Rue du Lt Col Dubois","35000 Rennes","T\xe9l. +33 2 99 00 00 00","contact@stirweld.fr"].forEach((t,a)=>e.text(t,40,90+14*a)),e.text("Destinataire :",350,90),e.text(y,350,104),e.setFontSize(10),e.text("Date : ".concat(new Date().toLocaleDateString()),40,170),e.text("Fournisseur : ".concat(y),40,184),(0,d.Ay)(e,{startY:200,head:[["Marque","R\xe9f","Description","PU HT","Qt\xe9","Total HT","TVA","Total TTC"]],body:N.map(e=>{let t=e.qty*e.pu,a=.2*t;return[(x.find(t=>t.Ref===e.Ref)||{}).Marque||"",e.Ref,e.description,e.pu.toFixed(2)+" €",String(e.qty),t.toFixed(2)+" €",a.toFixed(2)+" €",(t+a).toFixed(2)+" €"]}),styles:{fontSize:9},headStyles:{fillColor:[0,166,178]},columnStyles:{3:{halign:"right"},4:{halign:"right"},5:{halign:"right"},6:{halign:"right"},7:{halign:"right"}}});let t=e.lastAutoTable.finalY+10;e.setFontSize(10),e.text("Total HT :",400,t),e.text(E.ht.toFixed(2)+" €",520,t,{align:"right"}),e.text("Total TVA :",400,t+14),e.text(E.tva.toFixed(2)+" €",520,t+14,{align:"right"}),e.setTextColor("#00a6b2").text("Total TTC :",400,t+28).text(E.ttc.toFixed(2)+" €",520,t+28,{align:"right"}).setTextColor("#000");let a="BC_".concat(y.replace(/\s+/g,"_"),".pdf");e.save(a);let s=e.output("blob"),l=new FormData;for(let e of(l.append("file",new File([s],a,{type:"application/pdf"})),l.append("fournisseur",y),l.append("lignes",JSON.stringify(N)),await fetch("/api/commandes",{method:"POST",body:l}),N)){let t=x.find(t=>t.Ref===e.Ref);t&&await fetch("/api/stock?edit=1",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({Ref:e.Ref,field:"En Commande",value:Number(t["En Commande"]||0)+e.qty})})}await m("/api/stock"),g(!1)}async function D(){let e=new Blob(["\uFEFF"+["Marque;R\xe9f;Description;PU HT;Qt\xe9;Total HT;TVA;Total TTC",...N.map(e=>{let t=e.qty*e.pu,a=.2*t,s=t+a;return[(x.find(t=>t.Ref===e.Ref)||{}).Marque||"",e.Ref,e.description,e.pu.toFixed(2).replace(".",",")+" €",String(e.qty),t.toFixed(2).replace(".",",")+" €",a.toFixed(2).replace(".",",")+" €",s.toFixed(2).replace(".",",")+" €"]}).map(e=>e.join(";"))].join("\r\n")],{type:"text/csv;charset=utf-8;"}),t="BC_".concat(y.replace(/\s+/g,"_"),".csv");if(navigator.msSaveBlob)navigator.msSaveBlob(e,t);else{let a=document.createElement("a"),s=URL.createObjectURL(e);a.setAttribute("href",s),a.setAttribute("download",t),a.style.visibility="hidden",document.body.appendChild(a),a.click(),document.body.removeChild(a)}let a=new FormData;for(let s of(a.append("file",new File([e],t,{type:"text/csv;charset=utf-8;"})),a.append("fournisseur",y),a.append("lignes",JSON.stringify(N)),await fetch("/api/commandes",{method:"POST",body:a}),N)){let e=x.find(e=>e.Ref===s.Ref);e&&await fetch("/api/stock?edit=1",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({Ref:s.Ref,field:"En Commande",value:Number(e["En Commande"]||0)+s.qty})})}await m("/api/stock"),g(!1)}return"loading"!==t&&e?p?(0,s.jsx)("p",{children:"Erreur de chargement"}):(0,s.jsxs)("div",{className:"p-6",children:[(0,s.jsx)("h1",{className:"text-2xl font-bold mb-4",children:"Alertes de stock bas"}),(0,s.jsxs)("div",{className:"flex items-center gap-2 mb-4",children:[(0,s.jsxs)("select",{value:h,onChange:e=>f(e.target.value),className:"border px-2 py-1",children:[(0,s.jsx)("option",{value:"",children:"— Tous fournisseurs —"}),q.map(e=>(0,s.jsx)("option",{children:e},e))]}),(0,s.jsx)("button",{onClick:function(){j(h||q[0]||""),g(!0)},disabled:!A.length,className:"ml-auto bg-blue-600 text-white px-4 py-1 rounded disabled:opacity-50",children:"G\xe9n\xe9rer bon de commande"})]}),0===A.length?(0,s.jsx)("p",{children:"Aucune alerte pour ce fournisseur."}):(0,s.jsx)("div",{className:"overflow-auto border rounded",children:(0,s.jsxs)("table",{className:"min-w-full table-auto",children:[(0,s.jsx)("thead",{className:"bg-red-100",children:(0,s.jsx)("tr",{children:["Marque","Ref","D\xe9signation","Fournisseurs","Stock","Mini","\xc0 commander"].map(e=>(0,s.jsx)("th",{className:"px-2 py-1 text-left",children:e},e))})}),(0,s.jsx)("tbody",{children:A.map((e,t)=>(0,s.jsxs)("tr",{className:t%2?"bg-red-50":"bg-white",children:[(0,s.jsx)("td",{className:"px-2 py-1",children:e.Marque}),(0,s.jsx)("td",{className:"px-2 py-1",children:e.Ref}),(0,s.jsx)("td",{className:"px-2 py-1",children:e["D\xe9signation"]}),(0,s.jsx)("td",{className:"px-2 py-1",children:e.Fournisseurs}),(0,s.jsx)("td",{className:"px-2 py-1",children:e["Qte stock"]}),(0,s.jsx)("td",{className:"px-2 py-1",children:e["Qte mini"]}),(0,s.jsx)("td",{className:"px-2 py-1 font-semibold",children:e.toOrder})]},e.Ref+t))})]})}),b&&(0,s.jsx)("div",{className:"fixed inset-0 bg-black/30 flex items-center justify-center z-50",children:(0,s.jsxs)("div",{className:"bg-white max-w-3xl w-full p-6 rounded shadow-lg space-y-4",children:[(0,s.jsx)("h2",{className:"text-xl font-bold",children:"Bon de commande"}),(0,s.jsxs)("label",{className:"block",children:["Fournisseur :",(0,s.jsx)("select",{value:y,onChange:e=>j(e.target.value),className:"border px-2 py-1 w-full mt-1",children:q.map(e=>(0,s.jsx)("option",{children:e},e))})]}),(0,s.jsx)("div",{className:"overflow-auto border rounded max-h-72",children:(0,s.jsxs)("table",{className:"min-w-full table-auto",children:[(0,s.jsx)("thead",{className:"bg-gray-100 sticky top-0",children:(0,s.jsx)("tr",{children:["R\xe9f","Description","PU HT (€)","Qt\xe9"].map(e=>(0,s.jsx)("th",{className:"px-2 py-1",children:e},e))})}),(0,s.jsx)("tbody",{children:N.map((e,t)=>(0,s.jsxs)("tr",{className:t%2?"bg-gray-50":"",children:[(0,s.jsx)("td",{className:"px-2 py-1",children:e.Ref}),(0,s.jsx)("td",{className:"px-2 py-1",children:e.description}),(0,s.jsx)("td",{className:"px-2 py-1",children:(0,s.jsx)("input",{type:"number",min:0,step:"0.01",value:e.pu,onChange:e=>{let a=Math.max(0,Number(e.target.value)||0);v(e=>{let s=[...e];return s[t].pu=a,s})},className:"w-24 border px-1"})}),(0,s.jsx)("td",{className:"px-2 py-1",children:(0,s.jsx)("input",{type:"number",min:1,value:e.qty,onChange:e=>{let a=Math.max(1,Number(e.target.value)||1);v(e=>{let s=[...e];return s[t].qty=a,s})},className:"w-16 border px-1"})})]},t))})]})}),(0,s.jsxs)("div",{className:"flex flex-wrap gap-2 items-end",children:[(0,s.jsxs)("label",{className:"flex-1",children:["Nouvelle r\xe9f",(0,s.jsx)("input",{value:T,onChange:e=>w(e.target.value),className:"border px-2 py-1 w-full"})]}),(0,s.jsxs)("label",{children:["PU HT (€)",(0,s.jsx)("input",{type:"number",min:0,step:"0.01",value:S,onChange:e=>R(Number(e.target.value)),className:"border px-2 py-1 w-24"})]}),(0,s.jsxs)("label",{children:["Qt\xe9",(0,s.jsx)("input",{type:"number",min:1,value:C,onChange:e=>F(Number(e.target.value)),className:"border px-2 py-1 w-20"})]}),(0,s.jsx)("button",{onClick:function(){let e=T.trim();!e||C<1||S<0||(v(t=>[...t,{Ref:e,description:"",qty:C,pu:S}]),w(""),F(1),R(0))},className:"bg-green-600 text-white px-4 py-1 rounded",children:"+ Ajouter"})]}),(0,s.jsxs)("div",{className:"text-right pr-2",children:[(0,s.jsxs)("p",{children:["Total HT : ",E.ht.toFixed(2)," €"]}),(0,s.jsxs)("p",{children:["Total TVA : ",E.tva.toFixed(2)," €"]}),(0,s.jsxs)("p",{className:"font-bold text-teal-600",children:["Total TTC : ",E.ttc.toFixed(2)," €"]})]}),(0,s.jsxs)("div",{className:"flex justify-end gap-2 pt-2",children:[(0,s.jsx)("button",{onClick:()=>g(!1),className:"px-4 py-1 border rounded",children:"Annuler"}),(0,s.jsx)("button",{onClick:_,className:"px-4 py-1 bg-blue-600 text-white rounded",children:"G\xe9n\xe9rer PDF"}),(0,s.jsx)("button",{onClick:D,className:"px-4 py-1 bg-green-600 text-white rounded",children:"G\xe9n\xe9rer CSV"})]})]})})]}):(0,s.jsx)("p",{children:"Chargement…"})}}},e=>{var t=t=>e(e.s=t);e.O(0,[347,307,636,593,792],()=>t(38882)),_N_E=e.O()}]);