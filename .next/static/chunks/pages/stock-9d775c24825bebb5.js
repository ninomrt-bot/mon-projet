(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[82],{51701:(e,s,t)=>{"use strict";t.r(s),t.d(s,{default:()=>d});var n=t(37876),a=t(14232),r=t(10553),l=t(89099),i=t(75656);let o=e=>fetch(e).then(e=>e.json()),u=["Marque","Ref","D\xe9signation","Fournisseurs","PU HT","Qte stock","Qte mini","En Commande"],c=["PU HT","Qte stock","Qte mini","En Commande"];function d(){let{data:e,status:s}=(0,r.useSession)(),t=(0,l.useRouter)(),{data:d,error:m,mutate:p}=(0,i.Ay)("/api/stock",o),{ref:x,highlight:h}=t.query,b=(0,a.useMemo)(()=>Array.isArray(d)?d.map(e=>{var s,t,n,a,r;let l={...e,Ref:String(null!=(s=e.Ref)?s:"").trim()},i={"PU HT":Number(null!=(t=e["PU HT"])?t:0),"Qte stock":Number(null!=(n=e["Qte stock"])?n:0),"Qte mini":Number(null!=(a=e["Qte mini"])?a:0),"En Commande":Number(null!=(r=e["En Commande"])?r:0)};return{...l,...i}}):[],[d]),[f,j]=(0,a.useState)(""),[g,N]=(0,a.useState)(""),[y,v]=(0,a.useState)(""),[w,C]=(0,a.useState)(null),[k,S]=(0,a.useState)(!1),[F,E]=(0,a.useState)(null),[T,_]=(0,a.useState)({}),[R,P]=(0,a.useState)({}),[q,M]=(0,a.useState)(!1),[O,A]=(0,a.useState)(u.reduce((e,s)=>({...e,[s]:c.includes(s)?0:""}),{}));(0,a.useEffect)(()=>{"unauthenticated"===s&&t.push("/login")},[s,t]);let Q=(0,a.useMemo)(()=>Array.from(new Set(b.map(e=>e.Marque).filter(Boolean))).sort(),[b]),U=(0,a.useMemo)(()=>Array.from(new Set(b.map(e=>e.Fournisseurs).filter(Boolean))).sort(),[b]),D=(0,a.useMemo)(()=>b.filter(e=>!g||e.Marque===g).filter(e=>!y||e.Fournisseurs===y).filter(e=>!f.trim()||"".concat(e.Marque," ").concat(e.Ref," ").concat(e["D\xe9signation"]," ").concat(e.Fournisseurs).toLowerCase().includes(f.toLowerCase().trim())),[b,g,y,f]),H=(0,a.useMemo)(()=>w?[...D].sort((e,s)=>{let t=e.Fournisseurs||"",n=s.Fournisseurs||"";return"asc"===w?t.localeCompare(n):n.localeCompare(t)}):D,[D,w]);async function L(){await Promise.all(u.map(async e=>{var s,t;String(null!=(s=F[e])?s:"")!==String(null!=(t=T[e])?t:"")&&await fetch("/api/stock",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({Ref:F.Ref,field:e,value:T[e]})})})),await p(),S(!1)}async function B(){await fetch("/api/stock?Ref=".concat(encodeURIComponent(F.Ref)),{method:"DELETE"}),await p(),S(!1)}async function I(s){s.preventDefault(),await fetch("/api/stock",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(O)}),await fetch("/api/mouvements",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({type:"entree",ref:O.Ref,valeur:Number(O["Qte stock"]),date:new Date().toISOString(),user:e.user.name,commentaire:"Ajout manuel stock"})}),await p(),M(!1)}return(0,a.useEffect)(()=>{"1"===h&&x&&setTimeout(()=>{let e=document.getElementById("item-".concat(x));e&&(e.scrollIntoView({behavior:"smooth",block:"center"}),e.classList.add("bg-yellow-200","transition","duration-500"),setTimeout(()=>{e.classList.remove("bg-yellow-200")},3e3))},200)},[h,x]),"loading"!==s&&e?m?(0,n.jsx)("p",{children:"Erreur de chargement"}):(0,n.jsxs)("div",{className:"p-6",children:[(0,n.jsxs)("h1",{className:"text-2xl mb-4",children:["Bonjour, ",e.user.name]}),(0,n.jsxs)("div",{className:"flex flex-wrap gap-2 mb-4",children:[(0,n.jsx)("input",{className:"border px-2 py-1 flex-1 min-w-[200px]",placeholder:"Rechercher…",value:f,onChange:e=>j(e.target.value)}),(0,n.jsxs)("select",{className:"border px-2 py-1",value:g,onChange:e=>N(e.target.value),children:[(0,n.jsx)("option",{value:"",children:"Toutes marques"}),Q.map(e=>(0,n.jsx)("option",{children:e},e))]}),(0,n.jsxs)("select",{className:"border px-2 py-1",value:y,onChange:e=>v(e.target.value),children:[(0,n.jsx)("option",{value:"",children:"Tous fournisseurs"}),U.map(e=>(0,n.jsx)("option",{children:e},e))]}),(0,n.jsx)("button",{onClick:function(){A(u.reduce((e,s)=>({...e,[s]:c.includes(s)?0:""}),{})),M(!0)},className:"bg-green-600 text-white px-4 py-1 rounded",children:"+ Ajouter"})]}),(0,n.jsx)("div",{className:"overflow-auto border rounded",children:(0,n.jsxs)("table",{className:"min-w-full table-auto",children:[(0,n.jsx)("thead",{className:"bg-gray-100",children:(0,n.jsx)("tr",{children:u.map(e=>{let s="Fournisseurs"===e;return(0,n.jsxs)("th",{className:"px-2 py-1 text-left select-none",style:s?{cursor:"pointer"}:{},onClick:s?()=>C(e=>"asc"===e?"desc":"desc"===e?null:"asc"):void 0,children:[e,s&&w?"asc"===w?" ↑":" ↓":""]},e)})})}),(0,n.jsx)("tbody",{children:H.map((e,s)=>(0,n.jsx)("tr",{id:"item-".concat(e.Ref),onDoubleClick:()=>{E(e),_({...e}),P({}),S(!0)},className:"".concat(s%2?"bg-gray-50":"bg-white"," hover:bg-gray-100 cursor-pointer"),children:u.map(s=>(0,n.jsx)("td",{className:"border px-2 py-1",children:"PU HT"===s?"".concat(e[s].toFixed(2)," €"):"En Commande"===s?e[s]>0?(0,n.jsx)("span",{className:"text-green-600 font-semibold",children:e[s]}):(0,n.jsx)("span",{className:"text-gray-500",children:e[s]}):e[s]},s))},"".concat(e.Ref,"|").concat(s)))})]})}),k&&(0,n.jsx)("div",{className:"fixed inset-0 bg-black/40 flex items-center justify-center z-50",children:(0,n.jsxs)("div",{className:"bg-white p-6 rounded shadow-lg w-96",children:[(0,n.jsx)("h2",{className:"text-xl font-bold mb-4",children:"Modifier / Supprimer"}),u.map(e=>{var s;let t=c.includes(e);return(0,n.jsxs)("div",{className:"mb-2",children:[(0,n.jsx)("label",{className:"block mb-1",children:e}),(0,n.jsx)("input",{type:t?"number":"text",min:t?0:void 0,value:null!=(s=T[e])?s:t?0:"",onChange:s=>{let n=t?Number(s.target.value):s.target.value;_(s=>({...s,[e]:n})),t&&n<0?P(s=>({...s,[e]:!0})):P(s=>{let t={...s};return delete t[e],t})},className:"border px-2 py-1 w-full ".concat(R[e]?"border-red-500":"")}),R[e]&&(0,n.jsx)("p",{className:"text-red-600 text-sm",children:"Valeur ≥ 0 requise"})]},e)}),(0,n.jsxs)("div",{className:"flex justify-end gap-2 mt-4",children:[(0,n.jsx)("button",{onClick:()=>S(!1),className:"px-4 py-1 border rounded",children:"Annuler"}),(0,n.jsx)("button",{onClick:B,className:"px-4 py-1 bg-red-600 text-white rounded",children:"Supprimer"}),(0,n.jsx)("button",{onClick:L,disabled:Object.keys(R).length>0,className:"px-4 py-1 text-white rounded ".concat(Object.keys(R).length?"bg-gray-400":"bg-blue-600"),children:"Enregistrer"})]})]})}),q&&(0,n.jsx)("div",{className:"fixed inset-0 bg-black/40 flex items-center justify-center z-50",children:(0,n.jsxs)("form",{onSubmit:I,className:"bg-white p-6 rounded shadow-lg w-96",children:[(0,n.jsx)("h2",{className:"text-xl font-bold mb-4",children:"Nouveau composant"}),u.map(e=>{let s=c.includes(e);return"Fournisseurs"===e?(0,n.jsxs)("div",{className:"mb-2",children:[(0,n.jsx)("label",{className:"block mb-1",children:e}),O.__addFournisseur?(0,n.jsxs)("div",{children:[(0,n.jsx)("div",{className:"flex items-center gap-2 mb-1",children:(0,n.jsx)("button",{type:"button",onClick:()=>A(e=>({...e,__addFournisseur:!1,Fournisseurs:""})),className:"text-blue-600 underline text-xs",children:"← Retour \xe0 la liste"})}),(0,n.jsx)("input",{autoFocus:!0,type:"text",placeholder:"Nouveau fournisseur",value:O.Fournisseurs,onChange:e=>A(s=>({...s,Fournisseurs:e.target.value})),className:"border px-2 py-1 w-full",required:!0})]}):(0,n.jsxs)("div",{children:[(0,n.jsx)("button",{type:"button",onClick:()=>A(e=>({...e,__addFournisseur:!0,Fournisseurs:""})),className:"mb-1 bg-blue-600 text-white text-xs px-2 py-1 rounded",children:"+ Nouveau fournisseur"}),(0,n.jsxs)("select",{value:O.Fournisseurs,onChange:e=>A(s=>({...s,Fournisseurs:e.target.value})),className:"border px-2 py-1 w-full",required:!0,children:[(0,n.jsx)("option",{value:"",children:"Choisir…"}),U.map(e=>(0,n.jsx)("option",{value:e,children:e},e))]})]})]},e):(0,n.jsxs)("div",{className:"mb-2",children:[(0,n.jsx)("label",{className:"block mb-1",children:e}),(0,n.jsx)("input",{required:!0,type:s?"number":"text",min:s?0:void 0,value:O[e],onChange:t=>A(n=>({...n,[e]:s?Number(t.target.value):t.target.value})),className:"border px-2 py-1 w-full"})]},e)}),(0,n.jsxs)("div",{className:"flex justify-end gap-2 mt-4",children:[(0,n.jsx)("button",{type:"button",onClick:()=>M(!1),className:"px-4 py-1 border rounded",children:"Annuler"}),(0,n.jsx)("button",{type:"submit",className:"px-4 py-1 bg-green-600 text-white rounded",children:"Cr\xe9er"})]})]})})]}):(0,n.jsx)("p",{children:"Chargement…"})}},78610:(e,s,t)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/stock",function(){return t(51701)}])}},e=>{var s=s=>e(e.s=s);e.O(0,[636,593,792],()=>s(78610)),_N_E=e.O()}]);