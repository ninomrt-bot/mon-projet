(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[694],{42563:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>m});var n=s(37876),r=s(14232),a=s(10553),i=s(89099),l=s(91535),c=s(75656),o=s(14312),d=s(9665);let u=e=>fetch(e).then(e=>e.json());function m(){let{data:e,status:t}=(0,a.useSession)(),s=(0,i.useRouter)(),{mutate:m}=(0,l.iX)(),[p,h]=(0,r.useState)(null),[x,f]=(0,r.useState)(1),[j,g]=(0,r.useState)(!1),[b,N]=(0,r.useState)(!1),[y,k]=(0,r.useState)([]),[w,v]=(0,r.useState)("");(0,r.useEffect)(()=>{"unauthenticated"===t&&s.push("/login")},[t,s]);let{data:R,error:S}=(0,c.Ay)("/api/projects",u),{data:C}=(0,c.Ay)(()=>(null==p?void 0:p.slug)?"/api/projects/".concat(encodeURIComponent(p.slug)):null,u),{data:q}=(0,c.Ay)("/api/stock",u),_=(0,r.useMemo)(()=>new Set((null==q?void 0:q.map(e=>String(e.Ref).trim()))||[]),[q]),E=(0,r.useMemo)(()=>{if(!C||!q)return[];let e=Object.fromEntries(q.map(e=>[String(e.Ref).trim(),Number(e["Qte stock"]||0)]));return C.components.map(t=>{let s=String(t.Ref).trim(),n=t.qte*x;return{Ref:s,Description:function(e,t){for(let s of t)if(e[s])return e[s];let s=e=>e.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g,"");for(let n of Object.keys(e))if(t.some(e=>s(e)===s(n)))return e[n];return""}(t,["Description","D\xe9signation"]),required:n,inStock:e[s]||0,missing:Math.max(0,n-(e[s]||0))}})},[C,q,x]);async function D(){if(0===y.length)return void v("Vous n'avez rien s\xe9lectionn\xe9 !");v(""),N(!0);try{await Promise.all(E.filter(e=>y.includes(e.Ref)).map(e=>fetch("/api/stock",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({Ref:e.Ref,field:"Qte stock",value:Math.max(0,e.inStock-e.required)})}))),await m("/api/stock"),g(!0)}finally{N(!1)}}return((0,r.useEffect)(()=>{E.length&&k(E.map(e=>e.Ref))},[E]),"loading"===t)?(0,n.jsx)("p",{children:"Chargement…"}):"unauthenticated"===t?null:S?(0,n.jsx)("p",{children:"Erreur chargement projets."}):(0,n.jsxs)("div",{className:"p-6",children:[(0,n.jsx)("h1",{className:"text-2xl mb-4",children:"Produits"}),!p&&(null==R?void 0:R.map(e=>(0,n.jsx)("button",{onClick:()=>h(e),className:"block w-full text-left px-4 py-2 bg-gray-100 rounded mb-2 hover:bg-gray-200",children:e.slug},e.slug))),p&&C&&q&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("button",{onClick:()=>h(null),className:"text-blue-600 hover:underline mb-4",children:"← Retour"}),(0,n.jsxs)("h2",{className:"text-xl font-semibold mb-2",children:["Projet : ",p.slug]}),(0,n.jsxs)("div",{className:"mb-4 flex flex-wrap items-center gap-2",children:[(0,n.jsx)("label",{children:"Quantit\xe9 :"}),(0,n.jsx)("input",{type:"number",min:1,value:x,onChange:e=>f(Number(e.target.value)),className:"border px-2 py-1 w-24"}),(0,n.jsx)("button",{onClick:D,className:"bg-green-600 text-white px-4 py-1 rounded",children:"D\xe9marrer"}),(0,n.jsx)("button",{onClick:function(){let e=new o.uE;e.text("Manque pour projet \xab ".concat(p.slug," \xbb"),14,20),(0,d.Ay)(e,{head:[["R\xe9f","Description","Requis","Stock","Manque"]],body:E.filter(e=>e.missing>0).map(e=>[e.Ref,e.Description,e.required,e.inStock,e.missing]),startY:30}),e.save("manque_".concat(p.slug,".pdf"))},className:"bg-red-600 text-white px-4 py-1 rounded ml-auto",children:"Export PDF manque"})]}),(0,n.jsxs)("div",{className:"mt-2 text-sm space-x-6",children:[(0,n.jsxs)("span",{className:"inline-flex items-center",children:[(0,n.jsx)("span",{className:"w-4 h-4 mr-1 rounded bg-red-100 border border-red-300"}),(0,n.jsx)("span",{children:"Manque (r\xe9f\xe9rence connue)"})]}),(0,n.jsxs)("span",{className:"inline-flex items-center",children:[(0,n.jsx)("span",{className:"w-4 h-4 mr-1 rounded bg-orange-100 border border-orange-300"}),(0,n.jsx)("span",{children:"Non r\xe9f\xe9renc\xe9e"})]})]}),w&&(0,n.jsx)("div",{className:"mb-2 text-red-600 font-semibold",children:w}),(0,n.jsx)("div",{className:"overflow-auto border rounded",children:(0,n.jsxs)("table",{className:"min-w-full table-auto",children:[(0,n.jsx)("thead",{className:"bg-gray-100",children:(0,n.jsxs)("tr",{children:[(0,n.jsx)("th",{children:(0,n.jsx)("input",{type:"checkbox",checked:y.length===E.length,onChange:e=>k(e.target.checked?E.map(e=>e.Ref):[])})}),["R\xe9f","Description","Requis","Stock","Manque"].map(e=>(0,n.jsx)("th",{className:"px-2 py-1 text-left whitespace-nowrap",children:e},e))]})}),(0,n.jsx)("tbody",{children:E.map((e,t)=>{let s=y.includes(e.Ref),r=e.missing>0?_.has(e.Ref)?"bg-red-100":"bg-orange-100":"";return(0,n.jsxs)("tr",{className:r,children:[(0,n.jsx)("td",{children:(0,n.jsx)("input",{type:"checkbox",checked:s,onChange:t=>{k(s=>t.target.checked?[...s,e.Ref]:s.filter(t=>t!==e.Ref))}})}),(0,n.jsx)("td",{className:"px-2 py-1",children:e.Ref}),(0,n.jsx)("td",{className:"px-2 py-1",children:e.Description}),(0,n.jsx)("td",{className:"px-2 py-1",children:e.required}),(0,n.jsx)("td",{className:"px-2 py-1",children:e.inStock}),(0,n.jsx)("td",{className:"px-2 py-1",children:e.missing})]},t)})})]})})]}),j&&(0,n.jsx)("div",{className:"fixed inset-0 bg-black/40 flex items-center justify-center z-50",children:(0,n.jsxs)("div",{className:"bg-white p-6 rounded shadow-lg space-y-4",children:[(0,n.jsxs)("p",{children:["Le projet \xab ",p.slug," \xbb a bien d\xe9marr\xe9 (",x,"\xd7)."]}),(0,n.jsx)("button",{onClick:()=>g(!1),className:"bg-blue-600 text-white px-4 py-1 rounded",children:"OK"})]})}),b&&(0,n.jsx)("div",{className:"fixed inset-0 bg-black/40 flex items-center justify-center z-40",children:(0,n.jsxs)("div",{className:"flex flex-col items-center",children:[(0,n.jsxs)("svg",{className:"animate-spin h-10 w-10 text-white",viewBox:"0 0 24 24",children:[(0,n.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,n.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8v8H4z"})]}),(0,n.jsx)("p",{className:"text-white mt-2",children:"Traitement…"})]})})]})}},78386:(e,t,s)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/projects",function(){return s(42563)}])}},e=>{var t=t=>e(e.s=t);e.O(0,[347,307,636,593,792],()=>t(78386)),_N_E=e.O()}]);