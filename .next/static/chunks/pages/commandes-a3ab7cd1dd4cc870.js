(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[15],{74278:(e,t,a)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/commandes",function(){return a(99270)}])},99270:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>h});var s=a(37876),n=a(14232),l=a(10553),r=a(89099),i=a(75656),d=a(47808);let c=n.forwardRef(function(e,t){let{title:a,titleId:s,...l}=e;return n.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true","data-slot":"icon",ref:t,"aria-labelledby":s},l),a?n.createElement("title",{id:s},a):null,n.createElement("path",{fillRule:"evenodd",d:"M16.5 4.478v.227a48.816 48.816 0 0 1 3.878.512.75.75 0 1 1-.256 1.478l-.209-.035-1.005 13.07a3 3 0 0 1-2.991 2.77H8.084a3 3 0 0 1-2.991-2.77L4.087 6.66l-.209.035a.75.75 0 0 1-.256-1.478A48.567 48.567 0 0 1 7.5 4.705v-.227c0-1.564 1.213-2.9 2.816-2.951a52.662 52.662 0 0 1 3.369 0c1.603.051 2.815 1.387 2.815 2.951Zm-6.136-1.452a51.196 51.196 0 0 1 3.273 0C14.39 3.05 15 3.684 15 4.478v.113a49.488 49.488 0 0 0-6 0v-.113c0-.794.609-1.428 1.364-1.452Zm-.355 5.945a.75.75 0 1 0-1.5.058l.347 9a.75.75 0 1 0 1.499-.058l-.346-9Zm5.48.058a.75.75 0 1 0-1.498-.058l-.347 9a.75.75 0 0 0 1.5.058l.345-9Z",clipRule:"evenodd"}))}),o=n.forwardRef(function(e,t){let{title:a,titleId:s,...l}=e;return n.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true","data-slot":"icon",ref:t,"aria-labelledby":s},l),a?n.createElement("title",{id:s},a):null,n.createElement("path",{fillRule:"evenodd",d:"M18.97 3.659a2.25 2.25 0 0 0-3.182 0l-10.94 10.94a3.75 3.75 0 1 0 5.304 5.303l7.693-7.693a.75.75 0 0 1 1.06 1.06l-7.693 7.693a5.25 5.25 0 1 1-7.424-7.424l10.939-10.94a3.75 3.75 0 1 1 5.303 5.304L9.097 18.835l-.008.008-.007.007-.002.002-.003.002A2.25 2.25 0 0 1 5.91 15.66l7.81-7.81a.75.75 0 0 1 1.061 1.06l-7.81 7.81a.75.75 0 0 0 1.054 1.068L18.97 6.84a2.25 2.25 0 0 0 0-3.182Z",clipRule:"evenodd"}))}),u=e=>fetch(e).then(e=>e.json()),m=["en cours","partielle","termin\xe9e"],p={"en cours":"bg-yellow-100",partielle:"bg-orange-100",terminée:"bg-green-100"};function h(){var e,t;let{data:a,status:h}=(0,l.useSession)(),f=(0,r.useRouter)(),{data:g,error:b,mutate:j}=(0,i.Ay)("authenticated"===h?"/api/commandes":null,u),[v,y]=(0,n.useState)(null),[N,w]=(0,n.useState)(null),[R,C]=(0,n.useState)(""),[E,S]=(0,n.useState)(""),[k,D]=(0,n.useState)(""),[_,T]=(0,n.useState)(!1);(0,n.useEffect)(()=>{"unauthenticated"===h&&f.push("/login")},[h,f]);let q=(0,n.useMemo)(()=>{let e=m.reduce((e,t)=>({...e,[t]:[]}),{});return(g||[]).forEach(t=>{e[m.includes(t.statut)?t.statut:"en cours"].push(t)}),e},[g]);async function P(e){if(e.preventDefault(),!v)return;let t=new FormData;t.append("file",v),await fetch("/api/commandes",{method:"POST",body:t}),y(null),j()}async function L(e,t){await fetch("/api/commandes",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:e,statut:t})}),j(),"termin\xe9e"===t&&(0,d.j)("/api/stock"),(null==N?void 0:N.id)===e&&w(e=>({...e,statut:t}))}async function O(){if(!N||!R.trim())return;await fetch("/api/commandes",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:N.id,newMessage:{from:a.user.name,text:R.trim(),at:new Date().toISOString()}})}),C("");let e=await u("/api/commandes");j(e,!1),w(e.find(e=>e.id===N.id))}async function F(e){confirm("Supprimer cette commande ?")&&(await fetch("/api/commandes?id=".concat(e),{method:"DELETE"}),j(),(null==N?void 0:N.id)===e&&w(null))}async function A(e){await fetch("/api/commandes",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:N.id,reception:e})}),j(),(0,d.j)("/api/stock"),T(!1),w(null)}return(0,n.useEffect)(()=>{var e;if(!N)return void D("");((null==(e=N.filename)?void 0:e.toLowerCase())||"").endsWith(".csv")&&N.url?fetch(N.url).then(e=>e.text()).then(e=>D(e)).catch(()=>D("Impossible de charger l’aper\xe7u CSV.")):D("")},[N]),"loading"===h?(0,s.jsx)("p",{children:"Connexion…"}):b?(0,s.jsx)("p",{className:"text-red-600",children:"Erreur de chargement"}):(0,s.jsxs)("div",{className:"p-6 space-y-6",children:[(0,s.jsx)("h1",{className:"text-2xl font-bold",children:"Commandes fournisseurs"}),(0,s.jsxs)("form",{onSubmit:P,className:"flex items-center gap-2",children:[(0,s.jsx)("input",{type:"file",accept:".pdf",onChange:e=>y(e.target.files[0]||null),className:"border p-1"}),(0,s.jsx)("button",{type:"submit",disabled:!v,className:"bg-blue-600 text-white rounded px-4 py-1 disabled:opacity-50",children:"Ajouter PDF"})]}),(0,s.jsx)("div",{className:"flex gap-4",children:m.map(e=>(0,s.jsxs)("div",{onDragOver:e=>e.preventDefault(),onDrop:()=>{E&&L(E,e),S("")},className:"flex-1 p-3 rounded space-y-2 ".concat(p[e]),children:[(0,s.jsx)("h2",{className:"font-semibold mb-2 capitalize",children:e}),q[e].map(e=>(0,s.jsxs)("div",{draggable:!0,onDragStart:()=>S(e.id),onClick:()=>{w(e),C("")},className:"bg-white rounded shadow p-3 space-y-1 cursor-move relative",children:[(0,s.jsx)("button",{onClick:t=>{t.stopPropagation(),F(e.id)},className:"absolute top-1 right-1 text-red-500",children:(0,s.jsx)(c,{className:"h-4 w-4"})}),(0,s.jsxs)("div",{className:"flex justify-between text-sm",children:[(0,s.jsx)("span",{children:e.filename||e.id}),e.url&&(0,s.jsx)(o,{className:"h-4 w-4 text-gray-500"})]}),(0,s.jsxs)("div",{className:"text-xs text-gray-500",children:["Cr\xe9\xe9 par ",e.creator]})]},e.id))]},e))}),N&&(0,s.jsx)("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center p-4",onClick:()=>w(null),children:(0,s.jsxs)("div",{className:"bg-white max-w-xl w-full rounded-lg overflow-auto shadow-lg",onClick:e=>e.stopPropagation(),children:[(0,s.jsxs)("div",{className:"flex justify-between items-center px-4 py-2 border-b",children:[(0,s.jsx)("h2",{className:"font-semibold",children:N.filename||N.id}),(0,s.jsx)("button",{onClick:()=>w(null),children:"✕"})]}),(0,s.jsxs)("div",{className:"p-4 space-y-4",children:[(0,s.jsxs)("p",{children:[(0,s.jsx)("strong",{children:"Statut :"})," ",N.statut]}),(0,s.jsxs)("p",{children:[(0,s.jsx)("strong",{children:"Fournisseur :"})," ",N.fournisseur||"N/A"]}),(0,s.jsxs)("p",{className:"text-sm text-gray-600",children:[(0,s.jsx)("strong",{children:"Cr\xe9\xe9 par :"})," ",N.creator," —"," ",new Date(N.createdAt).toLocaleString("fr-FR")]}),(null==(e=N.url)?void 0:e.toLowerCase().endsWith(".pdf"))&&(0,s.jsx)("div",{className:"h-72 border",children:(0,s.jsxs)("object",{data:N.url,type:"application/pdf",width:"100%",height:"100%",children:["PDF non support\xe9.",(0,s.jsx)("a",{href:N.url,target:"_blank",rel:"noopener noreferrer",className:"text-blue-600 underline",children:"T\xe9l\xe9charger le PDF"})]})}),(null==(t=N.url)?void 0:t.toLowerCase().endsWith(".csv"))&&(0,s.jsx)("div",{className:"overflow-auto border rounded max-h-72",children:k?(0,s.jsxs)("table",{className:"min-w-full table-auto text-xs",children:[(0,s.jsx)("thead",{className:"bg-gray-100",children:(0,s.jsx)("tr",{children:k.trim().split("\n")[0].split(";").map((e,t)=>(0,s.jsx)("th",{className:"px-2 py-1 text-left",children:e},t))})}),(0,s.jsx)("tbody",{children:k.trim().split("\n").slice(1).filter(e=>e.trim().length>0).map((e,t)=>{let a=e.split(";");return(0,s.jsx)("tr",{className:t%2?"bg-gray-50":"",children:a.map((e,t)=>(0,s.jsx)("td",{className:"px-2 py-1 whitespace-nowrap",children:e},t))},t)})})]}):(0,s.jsx)("p",{className:"p-4 text-gray-600",children:"Chargement de l’aper\xe7u CSV…"})}),"partielle"===N.statut&&k&&(0,s.jsx)("button",{className:"bg-blue-600 text-white px-3 py-1 rounded",onClick:()=>T(!0),children:"R\xe9ception partielle"}),_&&(0,s.jsx)(x,{lignes:function(e){if(!e)return[];let[t,...a]=e.trim().split("\n"),s=t.split(";");return a.filter(e=>e.trim()).map(e=>{let t=e.split(";"),a={};return s.forEach((e,s)=>{var n;return a[e.trim()]=(null==(n=t[s])?void 0:n.trim())||""}),a.Ref=a.Ref||a["R\xe9f"]||a.ref||a.REF||"",a.Designation=a["D\xe9signation"]||a.Designation||"",a.qty=Number(a["Qt\xe9"])||Number(a.Qte)||Number(a["Quantit\xe9"])||Number(a["Qte command\xe9e"])||Number(a["En Commande"])||0,a})}(k),onClose:()=>T(!1),onValide:A,dejaRecues:N.receivedLines||[]}),(0,s.jsx)("div",{className:"border p-2 max-h-48 overflow-y-auto text-sm space-y-2",children:(N.messages||[]).map((e,t)=>(0,s.jsxs)("div",{children:[(0,s.jsx)("span",{className:"font-medium",children:e.from})," ",(0,s.jsx)("span",{className:"text-xs text-gray-500",children:new Date(e.at).toLocaleTimeString("fr-FR")}),(0,s.jsx)("div",{children:e.text})]},t))}),(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsx)("input",{value:R,onChange:e=>C(e.target.value),placeholder:"Message…",className:"flex-1 border px-2 py-1 rounded"}),(0,s.jsx)("button",{onClick:O,disabled:!R.trim(),className:"bg-green-600 text-white rounded px-4 disabled:opacity-50",children:"Envoyer"})]})]})]})})]})}function x(e){let{lignes:t,onClose:a,onValide:l,dejaRecues:r}=e,[i,d]=(0,n.useState)({}),[c,o]=(0,n.useState)({});return(0,n.useEffect)(()=>{let e={},t={};(r||[]).forEach(a=>{a.Ref&&(e[a.Ref]=!0,t[a.Ref]=a.qty)}),d(e),o(t)},[r]),(0,s.jsx)("div",{className:"fixed inset-0 bg-black/40 flex items-center justify-center z-50",children:(0,s.jsxs)("div",{className:"bg-white p-6 rounded shadow-lg w-[400px]",children:[(0,s.jsx)("h2",{className:"text-lg font-bold mb-2",children:"R\xe9ception partielle"}),(0,s.jsxs)("form",{onSubmit:e=>{e.preventDefault(),l(t.filter(e=>i[e.Ref]).map(e=>({...e,qty:Number(c[e.Ref])||0})).filter(e=>e.qty>0))},children:[(0,s.jsx)("div",{className:"max-h-60 overflow-auto mb-4",children:t.map(e=>{var t;let a=(null==(t=(r||[]).find(t=>t.Ref===e.Ref))?void 0:t.qty)||0,n=a>=Number(e.qty||0);return(0,s.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[(0,s.jsx)("input",{type:"checkbox",checked:!!i[e.Ref],disabled:n,onChange:t=>{d(a=>({...a,[e.Ref]:t.target.checked})),t.target.checked&&void 0===c[e.Ref]&&o(t=>({...t,[e.Ref]:e.qty}))}}),(0,s.jsxs)("span",{children:[e.Ref," — ",e.Designation,n&&(0,s.jsx)("span",{className:"ml-2 text-green-600 text-xs font-semibold",children:"(d\xe9j\xe0 ajout\xe9)"}),!n&&a>0&&(0,s.jsxs)("span",{className:"ml-2 text-orange-600 text-xs font-semibold",children:["(d\xe9j\xe0 re\xe7u : ",a,"/",e.qty,")"]})]}),i[e.Ref]&&!n&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("input",{type:"number",min:1,max:Number(e.qty)||1,value:void 0!==c[e.Ref]?c[e.Ref]:e.qty,onChange:t=>o(a=>({...a,[e.Ref]:t.target.value})),className:"border px-1 w-16"}),(0,s.jsxs)("span",{children:["/ ",e.qty]})]})]},e.Ref||e.Designation||Math.random())})}),(0,s.jsxs)("div",{className:"flex gap-2 justify-end",children:[(0,s.jsx)("button",{type:"button",onClick:a,className:"border px-3 py-1 rounded",children:"Annuler"}),(0,s.jsx)("button",{className:"bg-green-600 text-white px-3 py-1 rounded",children:"Valider r\xe9ception"})]})]})]})})}}},e=>{var t=t=>e(e.s=t);e.O(0,[636,593,792],()=>t(74278)),_N_E=e.O()}]);