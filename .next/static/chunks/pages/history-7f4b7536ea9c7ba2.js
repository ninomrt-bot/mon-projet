(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[272],{8054:(e,t,l)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/history",function(){return l(56607)}])},18847:(e,t,l)=>{e.exports=l(71147)},21650:(e,t,l)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"LoadableContext",{enumerable:!0,get:function(){return a}});let a=l(64252)._(l(14232)).default.createContext(null)},52100:(e,t,l)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"default",{enumerable:!0,get:function(){return p}});let a=l(64252)._(l(14232)),r=l(21650),n=[],s=[],o=!1;function i(e){let t=e(),l={loading:!0,loaded:null,error:null};return l.promise=t.then(e=>(l.loading=!1,l.loaded=e,e)).catch(e=>{throw l.loading=!1,l.error=e,e}),l}class d{promise(){return this._res.promise}retry(){this._clearTimeouts(),this._res=this._loadFn(this._opts.loader),this._state={pastDelay:!1,timedOut:!1};let{_res:e,_opts:t}=this;e.loading&&("number"==typeof t.delay&&(0===t.delay?this._state.pastDelay=!0:this._delay=setTimeout(()=>{this._update({pastDelay:!0})},t.delay)),"number"==typeof t.timeout&&(this._timeout=setTimeout(()=>{this._update({timedOut:!0})},t.timeout))),this._res.promise.then(()=>{this._update({}),this._clearTimeouts()}).catch(e=>{this._update({}),this._clearTimeouts()}),this._update({})}_update(e){this._state={...this._state,error:this._res.error,loaded:this._res.loaded,loading:this._res.loading,...e},this._callbacks.forEach(e=>e())}_clearTimeouts(){clearTimeout(this._delay),clearTimeout(this._timeout)}getCurrentValue(){return this._state}subscribe(e){return this._callbacks.add(e),()=>{this._callbacks.delete(e)}}constructor(e,t){this._loadFn=e,this._opts=t,this._callbacks=new Set,this._delay=null,this._timeout=null,this.retry()}}function u(e){return function(e,t){let l=Object.assign({loader:null,loading:null,delay:200,timeout:null,webpack:null,modules:null},t),n=null;function i(){if(!n){let t=new d(e,l);n={getCurrentValue:t.getCurrentValue.bind(t),subscribe:t.subscribe.bind(t),retry:t.retry.bind(t),promise:t.promise.bind(t)}}return n.promise()}if(!o){let e=l.webpack&&1?l.webpack():l.modules;e&&s.push(t=>{for(let l of e)if(t.includes(l))return i()})}function u(e,t){i();let s=a.default.useContext(r.LoadableContext);s&&Array.isArray(l.modules)&&l.modules.forEach(e=>{s(e)});let o=a.default.useSyncExternalStore(n.subscribe,n.getCurrentValue,n.getCurrentValue);return a.default.useImperativeHandle(t,()=>({retry:n.retry}),[]),a.default.useMemo(()=>{var t;return o.loading||o.error?a.default.createElement(l.loading,{isLoading:o.loading,pastDelay:o.pastDelay,timedOut:o.timedOut,error:o.error,retry:n.retry}):o.loaded?a.default.createElement((t=o.loaded)&&t.default?t.default:t,e):null},[e,o])}return u.preload=()=>i(),u.displayName="LoadableComponent",a.default.forwardRef(u)}(i,e)}function c(e,t){let l=[];for(;e.length;){let a=e.pop();l.push(a(t))}return Promise.all(l).then(()=>{if(e.length)return c(e,t)})}u.preloadAll=()=>new Promise((e,t)=>{c(n).then(e,t)}),u.preloadReady=e=>(void 0===e&&(e=[]),new Promise(t=>{let l=()=>(o=!0,t());c(s,e).then(l,l)})),window.__NEXT_PRELOADREADY=u.preloadReady;let p=u},56607:(e,t,l)=>{"use strict";l.r(t),l.d(t,{default:()=>f});var a=l(37876),r=l(14232),n=l(48230),s=l.n(n),o=l(75656),i=l(10553),d=l(89099),u=l(14312),c=l(9665),p=l(18847),h=l.n(p);let m=e=>fetch(e,{cache:"no-store"}).then(e=>{if(!e.ok)throw Error("Erreur r\xe9seau");return e.json()});function f(){let{data:e,status:t}=(0,i.useSession)(),l=(0,d.useRouter)();(0,r.useEffect)(()=>{"unauthenticated"===t&&l.push("/login")},[t,l]);let{data:n=[],error:p}=(0,o.Ay)("authenticated"===t?"/api/history":null,m),[h,f]=(0,r.useState)(!1);(0,r.useEffect)(()=>f(!0),[]);let[y,x]=(0,r.useState)(""),[b,g]=(0,r.useState)(""),[j,_]=(0,r.useState)(""),[w,v]=(0,r.useState)(""),[N,k]=(0,r.useState)(""),[S,C]=(0,r.useState)(!1),[V,P]=(0,r.useState)("detail"),[E,R]=(0,r.useState)("type"),[T,D]=(0,r.useState)(null),O=(0,r.useMemo)(()=>n.map(e=>{var t,l,a,r,n;let s=new Date(e.timestamp);return{key:e.id||e.timestamp,date:s,dateStr:s.toLocaleString("fr-FR"),user:e.user,type:e.type,ref:null!=(t=e.ref)?t:"",field:null!=(a=null!=(l=e.field)?l:e.statField)?a:"",oldVal:null!=e.oldValue?e.oldValue:null!=(r=e.oldStatus)?r:"",newVal:null!=e.newValue?e.newValue:null!=(n=e.newStatus)?n:""}}),[n]),L=(0,r.useMemo)(()=>Array.from(new Set(O.map(e=>e.user))).sort(),[O]),M=(0,r.useMemo)(()=>Array.from(new Set(O.map(e=>e.type))).sort(),[O]),A=(0,r.useMemo)(()=>O.filter(e=>(!b||e.user===b)&&(!j||e.type===j)&&(!y||!![e.dateStr,e.user,e.type,e.ref,e.field,e.oldVal,e.newVal].join(" ").toLowerCase().includes(y.toLowerCase()))&&!(w&&e.date<new Date(w)||N&&e.date>new Date(N+"T23:59:59"))),[O,b,j,y,w,N]),G=(0,r.useMemo)(()=>[...A].sort((e,t)=>S?e.date-t.date:t.date-e.date),[A,S]),F=(0,r.useMemo)(()=>{if("resume"!==V)return[];let e={};return G.forEach(t=>{let l=t[E]||"(vide)";e[l]=(e[l]||0)+1}),Object.entries(e).map(e=>{let[t,l]=e;return{key:t,count:l}})},[V,E,G]),U=(0,r.useMemo)(()=>(function(e){let t=new Date,l=[];for(let e=6;e>=0;e--){let a=new Date(t);a.setDate(t.getDate()-e),l.push(a.toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit"}))}return l})(0),[]),q=(0,r.useMemo)(()=>(function(e){let t={};return e.forEach(e=>{let l=new Date(e.timestamp).toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit"});t[l]=(t[l]||0)+1}),t})(G),[G]);return((0,r.useMemo)(()=>U.map(e=>({jour:e,actions:q[e]||0})),[U,q]),"loading"!==t&&n)?p?(0,a.jsx)("p",{className:"text-red-600",children:"Erreur de chargement"}):(0,a.jsxs)("div",{className:"p-6 space-y-6",children:[(0,a.jsx)("h1",{className:"text-2xl font-bold",children:"Historique des actions"}),(0,a.jsxs)("div",{className:"flex flex-wrap gap-2 items-end",children:[(0,a.jsxs)("select",{value:b,onChange:e=>g(e.target.value),className:"border px-2 py-1 rounded",children:[(0,a.jsx)("option",{value:"",children:"Tous utilisateurs"}),L.map(e=>(0,a.jsx)("option",{value:e,children:e},e))]}),(0,a.jsxs)("select",{value:j,onChange:e=>_(e.target.value),className:"border px-2 py-1 rounded",children:[(0,a.jsx)("option",{value:"",children:"Tous types"}),M.map(e=>(0,a.jsx)("option",{value:e,children:e},e))]}),(0,a.jsx)("input",{type:"date",value:w,onChange:e=>v(e.target.value),className:"border px-2 py-1 rounded"}),(0,a.jsx)("input",{type:"date",value:N,onChange:e=>k(e.target.value),className:"border px-2 py-1 rounded"}),(0,a.jsx)("input",{type:"text",placeholder:"Recherche…",value:y,onChange:e=>x(e.target.value),className:"border px-2 py-1 rounded flex-1 min-w-[150px]"}),(0,a.jsxs)("button",{onClick:()=>C(e=>!e),className:"border px-3 py-1 rounded hover:bg-gray-200",children:["Trier : ",S?"ancien→r\xe9cent":"r\xe9cent→ancien"]}),(0,a.jsxs)("select",{value:V,onChange:e=>P(e.target.value),className:"border px-2 py-1 rounded",children:[(0,a.jsx)("option",{value:"detail",children:"Mode d\xe9tail"}),(0,a.jsx)("option",{value:"resume",children:"Mode r\xe9sum\xe9"})]}),"resume"===V&&(0,a.jsxs)("select",{value:E,onChange:e=>R(e.target.value),className:"border px-2 py-1 rounded",children:[(0,a.jsx)("option",{value:"type",children:"Grouper par type"}),(0,a.jsx)("option",{value:"ref",children:"Grouper par r\xe9f\xe9rence"})]}),(0,a.jsx)("button",{onClick:function(){let e="detail"===V?["Date","Utilisateur","Type","R\xe9f","Champ","Ancienne","Nouvelle"]:["type"===E?"Type":"R\xe9f","Nombre"],t="detail"===V?G.map(e=>[e.dateStr,e.user,e.type,e.ref,e.field,e.oldVal,e.newVal]):F.map(e=>[e.key,e.count]),l=new Blob([[e.join(","),...t.map(e=>e.map(e=>'"'.concat(String(e).replace(/"/g,'""'),'"')).join(","))].join("\n")],{type:"text/csv"}),a=URL.createObjectURL(l),r=document.createElement("a");r.href=a,r.download="historique.csv",r.click(),URL.revokeObjectURL(a)},className:"bg-blue-600 text-white px-4 py-1 rounded hover:bg-blue-700",children:"Export CSV"}),(0,a.jsx)("button",{onClick:function(){let e=new u.Ay;e.setFontSize(14),e.text("Historique des actions",14,20);let t="detail"===V?[["Date","Utilisateur","Type","R\xe9f","Champ","Ancienne","Nouvelle"]]:[["type"===E?"Type":"R\xe9f","Nombre"]],l="detail"===V?G.map(e=>[e.dateStr,e.user,e.type,e.ref,e.field,e.oldVal,e.newVal]):F.map(e=>[e.key,e.count]);(0,c.Ay)(e,{startY:30,head:t,body:l}),e.save("historique.pdf")},className:"bg-green-600 text-white px-4 py-1 rounded hover:bg-green-700",children:"Export PDF"})]}),(0,a.jsx)("div",{className:"overflow-auto border rounded",children:(0,a.jsxs)("table",{className:"min-w-full table-auto",children:[(0,a.jsx)("thead",{className:"bg-gray-100",children:(0,a.jsx)("tr",{children:"detail"===V?["Date","Utilisateur","Type","R\xe9f","Champ","Ancienne","Nouvelle",""].map(e=>(0,a.jsx)("th",{className:"px-2 py-1 text-left",children:e},e)):["type"===E?"Type":"R\xe9f","Nombre",""].map(e=>(0,a.jsx)("th",{className:"px-2 py-1 text-left",children:e},e))})}),(0,a.jsx)("tbody",{children:("detail"===V?G:F).map((e,t)=>{let l=e.key;return(0,a.jsxs)(r.Fragment,{children:[(0,a.jsx)("tr",{className:"hover:bg-gray-50 cursor-pointer",onClick:()=>D(e=>e===l?null:l),children:"detail"===V?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("td",{className:"px-2 py-1",children:e.dateStr}),(0,a.jsx)("td",{className:"px-2 py-1",children:e.user}),(0,a.jsx)("td",{className:"px-2 py-1",children:e.type}),(0,a.jsx)("td",{className:"px-2 py-1",children:e.ref}),(0,a.jsx)("td",{className:"px-2 py-1",children:e.field}),(0,a.jsx)("td",{className:"px-2 py-1",children:"object"==typeof e.oldVal&&null!==e.oldVal?JSON.stringify(e.oldVal):e.oldVal}),(0,a.jsx)("td",{className:"px-2 py-1",children:"object"==typeof e.newVal&&null!==e.newVal?JSON.stringify(e.newVal):e.newVal}),(0,a.jsx)("td",{className:"px-2 py-1 text-center",children:"⌄"})]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("td",{className:"px-2 py-1",children:e.key}),(0,a.jsx)("td",{className:"px-2 py-1",children:e.count}),(0,a.jsx)("td",{className:"px-2 py-1 text-center",children:"⌄"})]})}),T===l&&"detail"===V&&(0,a.jsx)("tr",{className:"bg-gray-50",children:(0,a.jsxs)("td",{colSpan:8,className:"px-4 py-2 text-sm text-gray-600",children:[(0,a.jsxs)("p",{children:[(0,a.jsx)("strong",{children:"Ancienne valeur :"})," ",e.oldVal]}),(0,a.jsxs)("p",{children:[(0,a.jsx)("strong",{children:"Nouvelle valeur :"})," ",e.newVal]}),e.type.startsWith("stock")&&(0,a.jsx)(s(),{href:{pathname:"/stock",query:{ref:e.ref,highlight:"1"}},className:"text-blue-600 hover:underline",children:"Voir le stock"}),e.type.startsWith("order")&&(0,a.jsx)(s(),{href:"/commandes",className:"text-blue-600 hover:underline ml-4",children:"Voir les commandes"})]})}),T===l&&"resume"===V&&(0,a.jsx)("tr",{className:"bg-gray-50",children:(0,a.jsxs)("td",{colSpan:3,className:"px-4 py-2 text-sm text-gray-600",children:[(0,a.jsx)("strong",{children:e.key})," : ",e.count," action(s)"]})})]},l+t)})})]})})]}):(0,a.jsx)("p",{children:"Chargement de l’historique…"})}h()(()=>Promise.all([l.e(398),l.e(175)]).then(l.bind(l,34175)).then(e=>e.ResponsiveContainer),{loadableGenerated:{webpack:()=>[34175]},ssr:!1}),h()(()=>Promise.all([l.e(398),l.e(175)]).then(l.bind(l,34175)).then(e=>e.LineChart),{loadableGenerated:{webpack:()=>[34175]},ssr:!1}),h()(()=>Promise.all([l.e(398),l.e(175)]).then(l.bind(l,34175)).then(e=>e.Line),{loadableGenerated:{webpack:()=>[34175]},ssr:!1}),h()(()=>Promise.all([l.e(398),l.e(175)]).then(l.bind(l,34175)).then(e=>e.XAxis),{loadableGenerated:{webpack:()=>[34175]},ssr:!1}),h()(()=>Promise.all([l.e(398),l.e(175)]).then(l.bind(l,34175)).then(e=>e.YAxis),{loadableGenerated:{webpack:()=>[34175]},ssr:!1}),h()(()=>Promise.all([l.e(398),l.e(175)]).then(l.bind(l,34175)).then(e=>e.CartesianGrid),{loadableGenerated:{webpack:()=>[34175]},ssr:!1}),h()(()=>Promise.all([l.e(398),l.e(175)]).then(l.bind(l,34175)).then(e=>e.Tooltip),{loadableGenerated:{webpack:()=>[34175]},ssr:!1}),h()(()=>Promise.all([l.e(398),l.e(175)]).then(l.bind(l,34175)).then(e=>e.Legend),{loadableGenerated:{webpack:()=>[34175]},ssr:!1})},71147:(e,t,l)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),!function(e,t){for(var l in t)Object.defineProperty(e,l,{enumerable:!0,get:t[l]})}(t,{default:function(){return o},noSSR:function(){return s}});let a=l(64252);l(37876),l(14232);let r=a._(l(52100));function n(e){return{default:(null==e?void 0:e.default)||e}}function s(e,t){return delete t.webpack,delete t.modules,e(t)}function o(e,t){let l=r.default,a={loading:e=>{let{error:t,isLoading:l,pastDelay:a}=e;return null}};e instanceof Promise?a.loader=()=>e:"function"==typeof e?a.loader=e:"object"==typeof e&&(a={...a,...e});let o=(a={...a,...t}).loader;return(a.loadableGenerated&&(a={...a,...a.loadableGenerated},delete a.loadableGenerated),"boolean"!=typeof a.ssr||a.ssr)?l({...a,loader:()=>null!=o?o().then(n):Promise.resolve(n(()=>null))}):(delete a.webpack,delete a.modules,s(l,a))}("function"==typeof t.default||"object"==typeof t.default&&null!==t.default)&&void 0===t.default.__esModule&&(Object.defineProperty(t.default,"__esModule",{value:!0}),Object.assign(t.default,t),e.exports=t.default)}},e=>{var t=t=>e(e.s=t);e.O(0,[347,307,636,593,792],()=>t(8054)),_N_E=e.O()}]);