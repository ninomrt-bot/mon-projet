"use strict";(()=>{var e={};e.id=766,e.ids=[766],e.modules={37:e=>{e.exports=import("uuid")},1572:e=>{e.exports=require("nodemailer")},3480:(e,t,r)=>{e.exports=r(5600)},3873:e=>{e.exports=require("path")},5600:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},5751:e=>{e.exports=require("xlsx")},5806:e=>{e.exports=require("next-auth/next")},5923:(e,t,r)=>{r.r(t),r.d(t,{authOptions:()=>u,default:()=>l});let a=require("next-auth");var n=r.n(a);let s=require("next-auth/providers/credentials");var i=r.n(s);let o=[{id:"1",username:"nino.marquet",password:"1",name:"Nino Marquet",email:"nino.marquet@stirweld.com",image:"/photo_user/Ninomarquet.jpg"},{id:"2",username:"anthony.trouve",password:"2",name:"Anthony Trouv\xe9",email:"anthony.trouve@stirweld.com",image:"/photo_user/Anthonytrouv\xe9.jpg"},{id:"3",username:"dominique.dubourg",password:"3",name:"Dominique Dubourg",email:"dominique.dubourg@stirweld.com",image:"/photo_user/Dominiquedubourg.jpg"},{id:"4",username:"gabin.dubourg",password:"4",name:"Gabin Dubourg",email:"gabin.dubourg@stirweld.com",image:"/photo_user/Gabindubourg.jpg"},{id:"5",username:"gabin.vigor",password:"leplusbeau",name:"Gabin Vigor",email:"gabin.vigor@stirweld.com",image:"/photo_user/Gabinvigor.jpg"},{id:"5",username:"admin",password:"12345",name:"admin",email:"admin",image:"/photo_user/Ninomarquet.JPG"}],u={session:{strategy:"jwt"},providers:[i()({name:"Credentials",credentials:{username:{label:"Utilisateur",type:"text"},password:{label:"Mot de passe",type:"password"}},async authorize(e){let t=o.find(t=>t.username===e.username&&t.password===e.password);return t?{id:t.id,name:t.name,email:t.email,image:t.image}:null}}),function(e){return{id:"asana",name:"Asana",type:"oauth",version:"2.0",scope:"default",params:{grant_type:"authorization_code"},authorization:{url:"https://app.asana.com/-/oauth_authorize",params:{response_type:"code"}},token:"https://app.asana.com/-/oauth_token",userinfo:"https://app.asana.com/api/1.0/users/me",clientId:e.clientId,clientSecret:e.clientSecret,async profile(e){let t=e.data;return{id:t.gid,name:t.name,email:t.email||null,image:t.photo?.image_60x60||null}},...e}}({clientId:process.env.ASANA_CLIENT_ID,clientSecret:process.env.ASANA_CLIENT_SECRET})],callbacks:{jwt:async({token:e,user:t,account:r})=>(t&&!r||r?.provider==="asana"&&r.access_token&&(e.asanaAccessToken=r.access_token),e),session:async({session:e,token:t})=>(t.name&&(e.user.name=t.name),t.email&&(e.user.email=t.email),t.image&&(e.user.image=t.image),t.asanaAccessToken&&(e.user.asanaAccessToken=t.asanaAccessToken),e)},pages:{signIn:"/login"},secret:process.env.NEXTAUTH_SECRET},l=n()(u)},6214:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{config:()=>N,default:()=>v});var n=r(9021),s=r(3873),i=r.n(s),o=r(7313),u=r(1572),l=r.n(u),m=r(5751),d=r.n(m),c=r(37),p=r(5806),f=r(5923),g=e([o,c]);[o,c]=g.then?(await g)():g;let A=i().join(process.cwd(),"data","commandes.json"),q=i().join(process.cwd(),"public","Stock.xlsm"),P=(i().join(process.cwd(),"data","stockHistory.json"),i().join(process.cwd(),"public","uploads"));async function h(){try{return JSON.parse(await n.promises.readFile(A,"utf8"))}catch{return[]}}async function y(e){await n.promises.mkdir(i().dirname(A),{recursive:!0}),await n.promises.writeFile(A,JSON.stringify(e,null,2))}async function b(e){let t=await n.promises.readFile(q),r=d().read(t,{type:"buffer"}),a=r.SheetNames[0],s=d().utils.sheet_to_json(r.Sheets[a],{defval:0});e.forEach(e=>{let t=s.findIndex(t=>String(t.Ref).trim()===String(e.Ref).trim());console.log("Traitement Ref:",e.Ref,"Trouv\xe9e:",-1!==t,"Qt\xe9 re\xe7ue:",e.qty),-1!==t&&(s[t]["Qte stock"]=Number(s[t]["Qte stock"]||0)+Number(e.qty),s[t]["En Commande"]=Math.max(0,Number(s[t]["En Commande"]||0)-Number(e.qty)))});let i=d().utils.json_to_sheet(s);r.Sheets[a]=i,d().writeFile(r,q)}function w({port:e,secure:t}){return l().createTransport({host:"smtp.gmail.com",port:e,secure:t,auth:{user:process.env.SMTP_USER,pass:process.env.SMTP_PASSWORD},tls:{rejectUnauthorized:!1}})}let E=w({port:465,secure:!0});E.verify().then(()=>{console.log("✅ SMTP 465 OK")}).catch(async e=>{console.error("⚠️  SMTP 465 KO :",e.message),console.log("⤹  Tentative sur 587 STARTTLS…"),E=w({port:587,secure:!1});try{await E.verify(),console.log("✅ SMTP 587 OK")}catch(e){console.error("❌ Impossible d’initialiser SMTP :",e.message)}});let N={api:{bodyParser:!1}},R=e=>new Promise((t,r)=>{let a="";e.on("data",e=>a+=e),e.on("end",()=>t(a)),e.on("error",r)});async function v(e,t){let r=await (0,p.getServerSession)(e,t,f.authOptions);if(!r)return t.status(401).json({error:"Non authentifi\xe9"});let a=r.user.name,s=r.user.email,u=await h();if("GET"===e.method)return t.status(200).json(u);if("POST"===e.method){if(e.headers["content-type"]?.startsWith("multipart/form-data")){await n.promises.mkdir(P,{recursive:!0}),(0,o.default)({uploadDir:P,keepExtensions:!0}).parse(e,async(e,r,n)=>{if(e)return t.status(500).send(e.message);let i=Array.isArray(n.file)?n.file[0]:n.file,o=`/uploads/${i.newFilename}`,l={id:(0,c.v4)(),fournisseur:r.fournisseur||"N/A",filename:i.originalFilename,url:o,lignes:JSON.parse(r.lignes||"[]"),statut:"en cours",createdAt:new Date().toISOString(),creator:a,creatorEmail:s,messages:[],comment:null};return u.push(l),await y(u),t.status(201).json(l)});return}try{let r=JSON.parse(await R(e)),n={id:(0,c.v4)(),fournisseur:r.fournisseur||"N/A",filename:r.pdfName||null,url:r.pdfName?`/uploads/${r.pdfName}`:null,lignes:r.lignes||[],statut:"en cours",createdAt:new Date().toISOString(),creator:a,creatorEmail:s,messages:[],comment:null};return u.push(n),await y(u),t.status(201).json(n)}catch{return t.status(400).send("JSON invalide")}}if("PUT"===e.method){let r=e.body;if(!r||"object"!=typeof r)try{let t=await R(e);r=JSON.parse(t)}catch{return t.status(400).json({error:"Corps de requ\xeate invalide"})}let{id:a,reception:n,statut:s}=r,i=u.findIndex(e=>e.id===a);if(-1===i)return t.status(404).send("Commande introuvable");let o=u[i];if(s&&"string"==typeof s){if(o.statut=s,"termin\xe9e"===s){if(o.lignes&&o.lignes.length>0){let e={};for(let t of o.lignes)e[t.Ref]=(e[t.Ref]||0)+Number(t.qty||0);let t={};for(let e of o.receivedLines||[])t[e.Ref]=(t[e.Ref]||0)+Number(e.qty||0);let r=Object.keys(e).map(r=>({Ref:r,qty:Math.max(0,e[r]-(t[r]||0))})).filter(e=>e.qty>0);if(r.length>0){await b(r);let e=[...o.receivedLines||[]];for(let t of r){let r=e.findIndex(e=>e.Ref===t.Ref);-1===r?e.push({Ref:t.Ref,qty:Number(t.qty)||0}):e[r].qty=Number(e[r].qty||0)+Number(t.qty||0)}o.receivedLines=e}}try{await S(o)}catch(e){console.error("Erreur envoi mail:",e)}}return await y(u),t.status(200).json({ok:!0})}if(n&&Array.isArray(n)){let e={};for(let t of o.receivedLines||[])e[t.Ref]=(e[t.Ref]||0)+Number(t.qty||0);let r=[];for(let t of n){let a=e[t.Ref]||0,n=Math.max(0,Number(t.qty||0)-a);n>0&&r.push({Ref:t.Ref,qty:n})}r.length>0&&await b(r);let a=[...o.receivedLines||[]];for(let e of n){let t=a.findIndex(t=>t.Ref===e.Ref);-1===t?a.push({Ref:e.Ref,qty:Number(e.qty)||0}):a[t].qty=Number(e.qty||0)}if(o.receivedLines=a,o.lignes&&o.lignes.length>0){let e={};for(let t of o.lignes)e[t.Ref]=(e[t.Ref]||0)+Number(t.qty||0);let t={};for(let e of o.receivedLines||[])t[e.Ref]=(t[e.Ref]||0)+Number(e.qty||0);o.statut=Object.keys(e).every(r=>(t[r]||0)>=e[r])?"termin\xe9e":"partielle"}await y(u),t.status(200).json({ok:!0});return}}if("DELETE"===e.method){let{id:r}=e.query,a=u.findIndex(e=>e.id===r);if(-1===a)return t.status(404).send("Commande introuvable");let[s]=u.splice(a,1);if(s.url)try{await n.promises.unlink(i().join(process.cwd(),"public",s.url))}catch{}return await y(u),t.status(204).end()}t.setHeader("Allow",["GET","POST","PUT","DELETE"]),t.status(405).end(`Method ${e.method} Not Allowed`)}async function S(e){let t=e.creatorEmail||(f.USERS.find(t=>t.name===e.creator)||{}).email||process.env.SMTP_USER;await E.sendMail({from:`"Stock App"<${process.env.SMTP_USER}>`,to:t,subject:`✅ BC "${e.filename||e.id}" re\xe7u`,text:`Bonjour ${e.creator},
Votre bon de commande "${e.filename||e.id}" est maintenant marqu\xe9 "re\xe7u".

Cordialement,
L’\xe9quipe Stock App`})}a()}catch(e){a(e)}})},6435:(e,t)=>{Object.defineProperty(t,"M",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},7104:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{config:()=>m,default:()=>l,routeModule:()=>d});var n=r(3480),s=r(8667),i=r(6435),o=r(6214),u=e([o]);o=(u.then?(await u)():u)[0];let l=(0,i.M)(o,"default"),m=(0,i.M)(o,"config"),d=new n.PagesAPIRouteModule({definition:{kind:s.A.PAGES_API,page:"/api/commandes",pathname:"/api/commandes",bundlePath:"",filename:""},userland:o});a()}catch(e){a(e)}})},7313:e=>{e.exports=import("formidable")},8667:(e,t)=>{Object.defineProperty(t,"A",{enumerable:!0,get:function(){return r}});var r=function(e){return e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE",e.IMAGE="IMAGE",e}({})},9021:e=>{e.exports=require("fs")}};var t=require("../../webpack-api-runtime.js");t.C(e);var r=t(t.s=7104);module.exports=r})();