"use strict";(()=>{var e={};e.id=71,e.ids=[71],e.modules={37:e=>{e.exports=import("uuid")},3480:(e,t,a)=>{e.exports=a(5600)},3873:e=>{e.exports=require("path")},4830:(e,t,a)=>{a.r(t),a.d(t,{default:()=>s});var n=a(9748),r=a(3873),i=a.n(r);async function s(e,t){let{type:a}=e.query,r=i().join(process.cwd(),"data","stockHistory.json"),s=[];try{s=JSON.parse(await (0,n.readFile)(r,"utf8"))||[]}catch{s=[]}let o=s.filter(e=>"stock_update"===e.type&&"Qte stock"===e.field).map(e=>({date:e.timestamp,delta:Number(e.newValue)-Number(e.oldValue)})).filter(e=>"entree"===a?e.delta>0:e.delta<0).map(e=>({date:e.date,valeur:Math.abs(e.delta)}));t.setHeader("Cache-Control","no-store"),t.status(200).json(o)}},5600:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},5751:e=>{e.exports=require("xlsx")},5806:e=>{e.exports=require("next-auth/next")},5923:(e,t,a)=>{a.r(t),a.d(t,{authOptions:()=>u,default:()=>l});let n=require("next-auth");var r=a.n(n);let i=require("next-auth/providers/credentials");var s=a.n(i);let o=[{id:"1",username:"nino.marquet",password:"1",name:"Nino Marquet",email:"nino.marquet@stirweld.com",image:"/photo_user/Ninomarquet.jpg"},{id:"2",username:"anthony.trouve",password:"2",name:"Anthony Trouv\xe9",email:"anthony.trouve@stirweld.com",image:"/photo_user/Anthonytrouv\xe9.jpg"},{id:"3",username:"dominique.dubourg",password:"3",name:"Dominique Dubourg",email:"dominique.dubourg@stirweld.com",image:"/photo_user/Dominiquedubourg.jpg"},{id:"4",username:"gabin.dubourg",password:"4",name:"Gabin Dubourg",email:"gabin.dubourg@stirweld.com",image:"/photo_user/Gabindubourg.jpg"},{id:"5",username:"gabin.vigor",password:"leplusbeau",name:"Gabin Vigor",email:"gabin.vigor@stirweld.com",image:"/photo_user/Gabinvigor.jpg"},{id:"5",username:"admin",password:"12345",name:"admin",email:"admin",image:"/photo_user/Ninomarquet.JPG"}],u={session:{strategy:"jwt"},providers:[s()({name:"Credentials",credentials:{username:{label:"Utilisateur",type:"text"},password:{label:"Mot de passe",type:"password"}},async authorize(e){let t=o.find(t=>t.username===e.username&&t.password===e.password);return t?{id:t.id,name:t.name,email:t.email,image:t.image}:null}}),function(e){return{id:"asana",name:"Asana",type:"oauth",version:"2.0",scope:"default",params:{grant_type:"authorization_code"},authorization:{url:"https://app.asana.com/-/oauth_authorize",params:{response_type:"code"}},token:"https://app.asana.com/-/oauth_token",userinfo:"https://app.asana.com/api/1.0/users/me",clientId:e.clientId,clientSecret:e.clientSecret,async profile(e){let t=e.data;return{id:t.gid,name:t.name,email:t.email||null,image:t.photo?.image_60x60||null}},...e}}({clientId:process.env.ASANA_CLIENT_ID,clientSecret:process.env.ASANA_CLIENT_SECRET})],callbacks:{jwt:async({token:e,user:t,account:a})=>(t&&!a||a?.provider==="asana"&&a.access_token&&(e.asanaAccessToken=a.access_token),e),session:async({session:e,token:t})=>(t.name&&(e.user.name=t.name),t.email&&(e.user.email=t.email),t.image&&(e.user.image=t.image),t.asanaAccessToken&&(e.user.asanaAccessToken=t.asanaAccessToken),e)},pages:{signIn:"/login"},secret:process.env.NEXTAUTH_SECRET},l=r()(u)},6435:(e,t)=>{Object.defineProperty(t,"M",{enumerable:!0,get:function(){return function e(t,a){return a in t?t[a]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,a)):"function"==typeof t&&"default"===a?t:void 0}}})},7007:(e,t,a)=>{a.a(e,async(e,n)=>{try{a.r(t),a.d(t,{default:()=>g});var r=a(9748),i=a(3873),s=a.n(i),o=a(5751),u=a.n(o),l=a(37),d=a(5806),m=a(5923),p=a(4830),c=e([l]);l=(c.then?(await c)():c)[0];let h=s().join(process.cwd(),"public","Stock.xlsm"),w=s().join(process.cwd(),"data","stockHistory.json");async function f(e){let t=[];try{t=JSON.parse(await (0,r.readFile)(w,"utf8")),Array.isArray(t)||(t=[])}catch(e){t=[]}t.push(e),await (0,r.writeFile)(w,JSON.stringify(t,null,2))}let y=["Qte stock","Qte mini","En Commande"];async function g(e,t){let a=await (0,d.getServerSession)(e,t,m.authOptions);if(!a)return t.status(401).json({error:"Non authentifi\xe9"});let n=a.user.name,i=await (0,r.readFile)(h),s=u().read(i,{type:"buffer"}),o=s.SheetNames[0],c=s.Sheets[o],g=u().utils.sheet_to_json(c,{defval:0,range:0});if(g.forEach(e=>{"En Commande"in e||(e["En Commande"]=0)}),"GET"===e.method)return t.status(200).json(g);if("POST"===e.method){let{Marque:a="",Ref:i="",Désignation:d="",Fournisseurs:m="","Qte stock":p=0,"Qte mini":c=0,"En Commande":w=0}=e.body,y={Marque:a,Ref:i,Désignation:d,Fournisseurs:m,"Qte stock":Number(p)||0,"Qte mini":Number(c)||0,"En Commande":Number(w)||0};return g.push(y),s.Sheets[o]=u().utils.json_to_sheet(g,{skipHeader:!1}),await (0,r.writeFile)(h,u().write(s,{bookType:"xlsm",type:"buffer"})),await f({id:(0,l.v4)(),type:"stock_create",ref:i,field:null,oldValue:null,newValue:y,user:n,timestamp:new Date().toISOString()}),t.status(201).json(y)}if("PUT"===e.method){let{Ref:a,field:i,value:d}=e.body,m=g.findIndex(e=>String(e.Ref)===String(a));if(-1===m)return t.status(404).json({error:"R\xe9f introuvable"});let c=g[m][i];return g[m][i]=y.includes(i)?Number(d)||0:d,s.Sheets[o]=u().utils.json_to_sheet(g,{skipHeader:!1}),await (0,r.writeFile)(h,u().write(s,{bookType:"xlsm",type:"buffer"})),await f({id:(0,l.v4)(),type:"stock_update",ref:a,field:i,oldValue:c,newValue:g[m][i],user:n,timestamp:new Date().toISOString()}),"Qte stock"===i&&(await f({id:(0,l.v4)(),type:"stock_update",ref:a,field:"Qte stock",oldValue:c,newValue:g[m][i],user:n,timestamp:new Date().toISOString()}),await (0,p.logStockUpdate)({ref:a,oldValue:c,newValue:g[m][i],user:n||"Syst\xe8me"})),t.status(200).json(g[m])}if("DELETE"===e.method){let{Ref:a}=e.query,i=g.findIndex(e=>String(e.Ref)===String(a));if(-1===i)return t.status(404).json({error:"R\xe9f introuvable"});let d=g.splice(i,1)[0];return s.Sheets[o]=u().utils.json_to_sheet(g,{skipHeader:!1}),await (0,r.writeFile)(h,u().write(s,{bookType:"xlsm",type:"buffer"})),await f({id:(0,l.v4)(),type:"stock_delete",ref:a,field:null,oldValue:d,newValue:null,user:n,timestamp:new Date().toISOString()}),t.status(204).end()}return t.setHeader("Allow",["GET","POST","PUT","DELETE"]),t.status(405).end()}n()}catch(e){n(e)}})},7606:(e,t,a)=>{a.a(e,async(e,n)=>{try{a.r(t),a.d(t,{config:()=>d,default:()=>l,routeModule:()=>m});var r=a(3480),i=a(8667),s=a(6435),o=a(7007),u=e([o]);o=(u.then?(await u)():u)[0];let l=(0,s.M)(o,"default"),d=(0,s.M)(o,"config"),m=new r.PagesAPIRouteModule({definition:{kind:i.A.PAGES_API,page:"/api/stock",pathname:"/api/stock",bundlePath:"",filename:""},userland:o});n()}catch(e){n(e)}})},8667:(e,t)=>{Object.defineProperty(t,"A",{enumerable:!0,get:function(){return a}});var a=function(e){return e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE",e.IMAGE="IMAGE",e}({})},9748:e=>{e.exports=require("fs/promises")}};var t=require("../../webpack-api-runtime.js");t.C(e);var a=t(t.s=7606);module.exports=a})();